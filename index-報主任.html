<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>海巡署圖書查詢系統</title>
  <script src="papaparse.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
    .banner { background: linear-gradient(to right, #3f51b5, #2196f3); color: white; display: flex; align-items: center; padding: 20px; }
    .logo { height: 100px; margin-right: 20px; }
    .banner-text h1 { margin: 0; font-size: 24px; }
    .banner-text p { margin: 5px 0 0; font-size: 14px; color: #e3f2fd; }
    .tab-buttons { display: flex; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
    .tab-buttons button { padding: 15px 30px; font-size: 18px; margin: 5px; border: none; background-color: #f48fb1; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; }
    .tab-buttons button:hover { background-color: #ec407a; }
    .tab-buttons button.active { background-color: #e91e63; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    .search-container { background-color: white; border: 2px solid #90caf9; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .search-container input { margin: 0 10px 10px 5px; padding: 6px; border: 1px solid #ccc; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
    th { background-color: #00bcd4; color: white; padding: 12px; }
    td { padding: 10px; border: 1px solid #ddd; background-color: #ffffff; }
    tr:nth-child(even) td { background-color: #f0f9ff; }
    tr:hover td { background-color: #a5d6a7; }
    #borrow-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #borrow-modal .modal-content { background: white; padding: 30px; border-radius: 12px; width: 400px; }
  </style>
</head>
<body>
<div class="banner">
  <img src="logo.png" alt="logo" class="logo">
  <div class="banner-text">
    <h1>海巡署教育訓練測考中心圖書查詢系統</h1>
    <p>Coast Guard Administration Education and Training Testing Center Library Query System</p>
  </div>
</div>

<div class="tab-buttons">
  <button class="active" onclick="switchTab('thesis', this)">論文查詢</button>
  <button onclick="switchTab('journal', this)">期刊查詢</button>
  <button onclick="switchTab('book', this)">書籍查詢</button>
  <button onclick="switchTab('borrow', this)">借出查詢</button>
</div>

<!-- 論文查詢 -->
<div id="thesis" class="tab-content active">
  <div class="search-container">
    <label>📚論文標題：</label><input type="text" class="filter" data-key="論文名稱" onkeyup="filterData('thesis')">
    <label>🧑‍🎓研究生：</label><input type="text" class="filter" data-key="研究生" onkeyup="filterData('thesis')">
    <label>👨‍🏫指導教授：</label><input type="text" class="filter" data-key="指導教授" onkeyup="filterData('thesis')">
  </div>
  <table>
<colgroup>
  <col style="width: 5%;">   <!-- 序號 -->
  <col style="width: 25%;">  <!-- 論文名稱 -->
  <col style="width: 10%;">  <!-- 研究生 -->
  <col style="width: 10%;">  <!-- 指導教授 -->
  <col style="width: 15%;">  <!-- 校院名稱 -->
  <col style="width: 15%;">  <!-- 系所名稱 -->
  <col style="width: 8%;">   <!-- 學位類別 -->
  <col style="width: 6%;">   <!-- 畢業學年度 -->
  <col style="width: 6%;">   <!-- 論文出版年 -->
</colgroup>

    <thead>
      <tr><th>序號</th><th>論文名稱</th><th>研究生</th><th>指導教授</th><th>校院名稱</th><th>系所名稱</th><th>學位類別</th><th>畢業學年度</th><th>論文出版年</th></tr>
    </thead>
    <tbody id="thesis-body"></tbody>
  </table>
</div>

<!-- 期刊查詢 -->
<div id="journal" class="tab-content">
  <div class="search-container">
    <label>刊名：</label><input type="text" class="filter" data-key="刊名" onkeyup="filterData('journal')">
    <label>期數：</label><input type="text" class="filter" data-key="期數" onkeyup="filterData('journal')">
    <label>出版者：</label><input type="text" class="filter" data-key="出 版 者" onkeyup="filterData('journal')">
  </div>
  <table>
<colgroup>
  <col style="width: 10%;">   <!-- 序號 -->
  <col style="width: 25%;">  <!-- 刊名 -->
  <col style="width: 15%;">  <!-- 出版者 -->
  <col style="width: 15%;">  <!-- 作者 -->
  <col style="width: 10%;">  <!-- 期數 -->
  <col style="width: 15%;">  <!-- 期刊分類 -->
  <col style="width: 10%;">  <!-- 藏書位置 -->
</colgroup>

    <thead>
      <tr><th>序號</th><th>刊名</th><th>出版者</th><th>作者</th><th>期數</th><th>期刊分類</th><th>藏書位置</th></tr>
    </thead>
    <tbody id="journal-body"></tbody>
  </table>
</div>

<!-- 書籍查詢 -->
<div id="book" class="tab-content">
  <div class="search-container">
    <label>書名：</label><input type="text" class="filter" data-key="書名" onkeyup="filterData('book')">
    <label>作者：</label><input type="text" class="filter" data-key="作者" onkeyup="filterData('book')">
    <label>分類：</label><input type="text" class="filter" data-key="分類" onkeyup="filterData('book')">
  </div>
  <table>
<colgroup>
  <col style="width: 5%;">    <!-- 序號 -->
  <col style="width: 25%;">   <!-- 書名 -->
  <col style="width: 12%;">   <!-- 作者 -->
  <col style="width: 12%;">   <!-- 出版者 -->
  <col style="width: 6%;">    <!-- 出版年 -->
  <col style="width: 10%;">   <!-- 分類 -->
  <col style="width: 10%;">   <!-- ISBN -->
  <col style="width: 8%;">    <!-- 藏書位置 -->
  <col style="width: 5%;">    <!-- 數量 -->
  <col style="width: 5%;">    <!-- 已借出 -->
  <col style="width: 7%;">    <!-- 歸還日期 -->
  <col style="width: 5%;">    <!-- 操作 -->
</colgroup>

    <thead>
      <tr><th>序號</th><th>書名</th><th>作者</th><th>出版者</th><th>出版年</th><th>分類</th><th>ISBN</th><th>藏書位置</th><th>數量</th><th>已借出</th><th>歸還日期</th><th>操作</th></tr>
    </thead>
    <tbody id="book-body"></tbody>
  </table>
</div>

<!-- 借出查詢 -->
<div id="borrow" class="tab-content">
  <h2>📋 借出記錄查詢</h2>
  <table>
    <thead><tr><th>班級</th><th>姓名</th><th>書名</th><th>ISBN</th><th>借出日</th><th>應還日</th><th>操作</th></tr></thead>
    <tbody id="borrow-body"></tbody>
  </table>
</div>

<!-- 借書 Modal -->
<div id="borrow-modal">
  <div class="modal-content">
    <h3>📖 借書登記</h3>
    <p><strong id="modal-book-title"></strong></p>
    <label>班級：</label><input id="class-input" type="text"><br><br>
    <label>姓名：</label><input id="name-input" type="text"><br><br>
    <p>借出日：<span id="borrow-date"></span></p>
    <p>應還日：<span id="return-date"></span></p>
    <button onclick="confirmBorrow()">✅ 確認借出</button>
    <button onclick="closeModal()">❌ 取消</button>
  </div>
</div>

<script>
const dataStore = { thesis: [], journal: [], book: [] };
let currentBorrowBook = null;

const columnsMap = {
  thesis: ["序號", "論文名稱", "研究生", "指導教授", "校院名稱", "系所名稱", "學位類別", "畢業學年度", "論文出版年"],
  journal: ["序號", "刊名", "出版者", "作者", "期數", "期刊分類", "藏書位置"],
  book: ["序號", "書名", "作者", "出版者", "出版年", "分類", "ISBN", "藏書位置", "數量", "已借出", "歸還日期"]
};

function switchTab(tabName, btn) {
  document.querySelectorAll(".tab-buttons button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  if (tabName === "borrow") loadBorrowedList();
}

function loadCSV(file, type) {
  Papa.parse(file, {
    download: true,
    header: true,
    complete: function(results) {
      const cleanData = results.data.filter(row => Object.values(row).some(val => val && val.trim() !== ''));
      dataStore[type] = cleanData;
      renderTable(type, cleanData);
    }
  });
}

function renderTable(type, data) {
  const body = document.getElementById(`${type}-body`);
  body.innerHTML = '';
  data.forEach(row => {
    const tr = document.createElement('tr');
    columnsMap[type].forEach(col => {
      const td = document.createElement('td');
      if (type === 'book' && (col === '已借出' || col === '歸還日期')) {
        const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
        const sameBookRecords = records.filter(r => r.ISBN === row["ISBN"]);
        if (col === '已借出') td.textContent = sameBookRecords.length;
        if (col === '歸還日期') {
          const latest = sameBookRecords.at(-1);
          td.textContent = latest ? latest.returnDate : '';
        }
      } else {
        td.textContent = row[col] || '';
      }
      tr.appendChild(td);
    });
    if (type === 'book') {
      const td = document.createElement('td');
      const total = parseInt(row["數量"] || 0);
      const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
      const borrowed = records.filter(r => r.ISBN === row["ISBN"]).length;
      if (borrowed < total) {
        td.innerHTML = `<button onclick='openBorrowModal(${JSON.stringify(row)})'>📖 借書</button>`;
      } else {
        td.textContent = '❌ 無可借';
      }
      tr.appendChild(td);
    }
    body.appendChild(tr);
  });
}

function filterData(type) {
  const filters = Array.from(document.querySelectorAll(`#${type} .filter`));
  const filtered = dataStore[type].filter(row =>
    filters.every(input => {
      const key = input.dataset.key;
      return (row[key] || '').toLowerCase().includes(input.value.toLowerCase());
    })
  );
  renderTable(type, filtered);
}

function openBorrowModal(bookData) {
  currentBorrowBook = bookData;
  const today = new Date();
  const returnDay = new Date(today);
  returnDay.setDate(today.getDate() + 14);
  document.getElementById("modal-book-title").textContent = bookData["書名"];
  document.getElementById("borrow-date").textContent = today.toISOString().split("T")[0];
  document.getElementById("return-date").textContent = returnDay.toISOString().split("T")[0];
  document.getElementById("class-input").value = '';
  document.getElementById("name-input").value = '';
  document.getElementById("borrow-modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("borrow-modal").style.display = "none";
}

function confirmBorrow() {
  const cls = document.getElementById("class-input").value.trim();
  const name = document.getElementById("name-input").value.trim();
  if (!cls || !name) return alert("請輸入完整資訊");

  const borrowDate = new Date();
  const returnDate = new Date(borrowDate);
  returnDate.setDate(borrowDate.getDate() + 14);

  const record = {
    class: cls,
    name: name,
    book: currentBorrowBook["書名"],
    ISBN: currentBorrowBook["ISBN"],
    borrowDate: borrowDate.toISOString().split("T")[0],
    returnDate: returnDate.toISOString().split("T")[0],
  };

  const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
  records.push(record);
  localStorage.setItem("borrowRecords", JSON.stringify(records));

  closeModal();
  renderTable("book", dataStore["book"]);
  alert("✅ 借書成功！");
}

function loadBorrowedList() {
  const tbody = document.getElementById("borrow-body");
  tbody.innerHTML = "";
  const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
  records.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.class}</td>
      <td>${r.name}</td>
      <td>${r.book}</td>
      <td>${r.ISBN}</td>
      <td>${r.borrowDate}</td>
      <td>${r.returnDate}</td>
      <td><button onclick="returnBook(${idx})">↩️ 歸還</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function returnBook(index) {
  const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
  records.splice(index, 1);
  localStorage.setItem("borrowRecords", JSON.stringify(records));
  loadBorrowedList();
  renderTable("book", dataStore["book"]);
}

window.onload = function() {
  loadCSV('thesis.csv', 'thesis');
  loadCSV('journal.csv', 'journal');
  loadCSV('books.csv', 'book');
}
</script>
</body>
</html>
