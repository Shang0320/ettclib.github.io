<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æµ·å·¡ç½²åœ–æ›¸æŸ¥è©¢ç³»çµ±</title>
  <script src="papaparse.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
    .banner { background: linear-gradient(to right, #3f51b5, #2196f3); color: white; display: flex; align-items: center; padding: 20px; }
    .logo { height: 100px; margin-right: 20px; }
    .banner-text h1 { margin: 0; font-size: 24px; }
    .banner-text p { margin: 5px 0 0; font-size: 14px; color: #e3f2fd; }
    .tab-buttons { display: flex; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
    .tab-buttons button { padding: 15px 30px; font-size: 18px; margin: 5px; border: none; background-color: #f48fb1; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; }
    .tab-buttons button:hover { background-color: #ec407a; }
    .tab-buttons button.active { background-color: #e91e63; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    .search-container { background-color: white; border: 2px solid #90caf9; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .search-container input { margin: 0 10px 10px 5px; padding: 6px; border: 1px solid #ccc; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
    th { background-color: #00bcd4; color: white; padding: 12px; }
    td { padding: 10px; border: 1px solid #ddd; background-color: #ffffff; }
    tr:nth-child(even) td { background-color: #f0f9ff; }
    tr:hover td { background-color: #a5d6a7; }
    #borrow-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #borrow-modal .modal-content { background: white; padding: 30px; border-radius: 12px; width: 400px; }
  </style>
</head>
<body>
<div class="banner">
  <img src="logo.png" alt="logo" class="logo">
  <div class="banner-text">
    <h1>æµ·å·¡ç½²æ•™è‚²è¨“ç·´æ¸¬è€ƒä¸­å¿ƒåœ–æ›¸æŸ¥è©¢ç³»çµ±</h1>
    <p>Coast Guard Administration Education and Training Testing Center Library Query System</p>
  </div>
</div>

<div class="tab-buttons">
  <button class="active" onclick="switchTab('thesis', this)">è«–æ–‡æŸ¥è©¢</button>
  <button onclick="switchTab('journal', this)">æœŸåˆŠæŸ¥è©¢</button>
  <button onclick="switchTab('book', this)">æ›¸ç±æŸ¥è©¢</button>
  <button onclick="switchTab('borrow', this)">å€Ÿå‡ºæŸ¥è©¢</button>
</div>

<!-- è«–æ–‡æŸ¥è©¢ -->
<div id="thesis" class="tab-content active">
  <div class="search-container">
    <label>ğŸ“šè«–æ–‡æ¨™é¡Œï¼š</label><input type="text" class="filter" data-key="è«–æ–‡åç¨±" onkeyup="filterData('thesis')">
    <label>ğŸ§‘â€ğŸ“ç ”ç©¶ç”Ÿï¼š</label><input type="text" class="filter" data-key="ç ”ç©¶ç”Ÿ" onkeyup="filterData('thesis')">
    <label>ğŸ‘¨â€ğŸ«æŒ‡å°æ•™æˆï¼š</label><input type="text" class="filter" data-key="æŒ‡å°æ•™æˆ" onkeyup="filterData('thesis')">
  </div>
  <table>
<colgroup>
  <col style="width: 5%;">   <!-- åºè™Ÿ -->
  <col style="width: 25%;">  <!-- è«–æ–‡åç¨± -->
  <col style="width: 10%;">  <!-- ç ”ç©¶ç”Ÿ -->
  <col style="width: 10%;">  <!-- æŒ‡å°æ•™æˆ -->
  <col style="width: 15%;">  <!-- æ ¡é™¢åç¨± -->
  <col style="width: 15%;">  <!-- ç³»æ‰€åç¨± -->
  <col style="width: 8%;">   <!-- å­¸ä½é¡åˆ¥ -->
  <col style="width: 6%;">   <!-- ç•¢æ¥­å­¸å¹´åº¦ -->
  <col style="width: 6%;">   <!-- è«–æ–‡å‡ºç‰ˆå¹´ -->
</colgroup>

    <thead>
      <tr><th>åºè™Ÿ</th><th>è«–æ–‡åç¨±</th><th>ç ”ç©¶ç”Ÿ</th><th>æŒ‡å°æ•™æˆ</th><th>æ ¡é™¢åç¨±</th><th>ç³»æ‰€åç¨±</th><th>å­¸ä½é¡åˆ¥</th><th>ç•¢æ¥­å­¸å¹´åº¦</th><th>è«–æ–‡å‡ºç‰ˆå¹´</th></tr>
    </thead>
    <tbody id="thesis-body"></tbody>
  </table>
</div>

<!-- æœŸåˆŠæŸ¥è©¢ -->
<div id="journal" class="tab-content">
  <div class="search-container">
    <label>åˆŠåï¼š</label><input type="text" class="filter" data-key="åˆŠå" onkeyup="filterData('journal')">
    <label>æœŸæ•¸ï¼š</label><input type="text" class="filter" data-key="æœŸæ•¸" onkeyup="filterData('journal')">
    <label>å‡ºç‰ˆè€…ï¼š</label><input type="text" class="filter" data-key="å‡º ç‰ˆ è€…" onkeyup="filterData('journal')">
  </div>
  <table>
<colgroup>
  <col style="width: 10%;">   <!-- åºè™Ÿ -->
  <col style="width: 25%;">  <!-- åˆŠå -->
  <col style="width: 15%;">  <!-- å‡ºç‰ˆè€… -->
  <col style="width: 15%;">  <!-- ä½œè€… -->
  <col style="width: 10%;">  <!-- æœŸæ•¸ -->
  <col style="width: 15%;">  <!-- æœŸåˆŠåˆ†é¡ -->
  <col style="width: 10%;">  <!-- è—æ›¸ä½ç½® -->
</colgroup>

    <thead>
      <tr><th>åºè™Ÿ</th><th>åˆŠå</th><th>å‡ºç‰ˆè€…</th><th>ä½œè€…</th><th>æœŸæ•¸</th><th>æœŸåˆŠåˆ†é¡</th><th>è—æ›¸ä½ç½®</th></tr>
    </thead>
    <tbody id="journal-body"></tbody>
  </table>
</div>

<!-- æ›¸ç±æŸ¥è©¢ -->
<div id="book" class="tab-content">
  <div class="search-container">
    <label>æ›¸åï¼š</label><input type="text" class="filter" data-key="æ›¸å" onkeyup="filterData('book')">
    <label>ä½œè€…ï¼š</label><input type="text" class="filter" data-key="ä½œè€…" onkeyup="filterData('book')">
    <label>åˆ†é¡ï¼š</label><input type="text" class="filter" data-key="åˆ†é¡" onkeyup="filterData('book')">
  </div>
  <table>
<colgroup>
  <col style="width: 5%;">    <!-- åºè™Ÿ -->
  <col style="width: 25%;">   <!-- æ›¸å -->
  <col style="width: 12%;">   <!-- ä½œè€… -->
  <col style="width: 12%;">   <!-- å‡ºç‰ˆè€… -->
  <col style="width: 6%;">    <!-- å‡ºç‰ˆå¹´ -->
  <col style="width: 10%;">   <!-- åˆ†é¡ -->
  <col style="width: 10%;">   <!-- ISBN -->
  <col style="width: 8%;">    <!-- è—æ›¸ä½ç½® -->
  <col style="width: 5%;">    <!-- æ•¸é‡ -->
  <col style="width: 5%;">    <!-- å·²å€Ÿå‡º -->
  <col style="width: 7%;">    <!-- æ­¸é‚„æ—¥æœŸ -->
  <col style="width: 5%;">    <!-- æ“ä½œ -->
</colgroup>

    <thead>
      <tr><th>åºè™Ÿ</th><th>æ›¸å</th><th>ä½œè€…</th><th>å‡ºç‰ˆè€…</th><th>å‡ºç‰ˆå¹´</th><th>åˆ†é¡</th><th>ISBN</th><th>è—æ›¸ä½ç½®</th><th>æ•¸é‡</th><th>å·²å€Ÿå‡º</th><th>æ­¸é‚„æ—¥æœŸ</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody id="book-body"></tbody>
  </table>
</div>

<!-- å€Ÿå‡ºæŸ¥è©¢ -->
<div id="borrow" class="tab-content">
  <h2>ğŸ“‹ å€Ÿå‡ºè¨˜éŒ„æŸ¥è©¢</h2>
  <table>
    <thead><tr><th>ç­ç´š</th><th>å§“å</th><th>æ›¸å</th><th>ISBN</th><th>å€Ÿå‡ºæ—¥</th><th>æ‡‰é‚„æ—¥</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="borrow-body"></tbody>
  </table>
</div>

<!-- å€Ÿæ›¸ Modal -->
<div id="borrow-modal">
  <div class="modal-content">
    <h3>ğŸ“– å€Ÿæ›¸ç™»è¨˜</h3>
    <p><strong id="modal-book-title"></strong></p>
    <label>ç­ç´šï¼š</label><input id="class-input" type="text"><br><br>
    <label>å§“åï¼š</label><input id="name-input" type="text"><br><br>
    <p>å€Ÿå‡ºæ—¥ï¼š<span id="borrow-date"></span></p>
    <p>æ‡‰é‚„æ—¥ï¼š<span id="return-date"></span></p>
    <button onclick="confirmBorrow()">âœ… ç¢ºèªå€Ÿå‡º</button>
    <button onclick="closeModal()">âŒ å–æ¶ˆ</button>
  </div>
</div>

<script>
const dataStore = { thesis: [], journal: [], book: [] };
let currentBorrowBook = null;

const columnsMap = {
  thesis: ["åºè™Ÿ", "è«–æ–‡åç¨±", "ç ”ç©¶ç”Ÿ", "æŒ‡å°æ•™æˆ", "æ ¡é™¢åç¨±", "ç³»æ‰€åç¨±", "å­¸ä½é¡åˆ¥", "ç•¢æ¥­å­¸å¹´åº¦", "è«–æ–‡å‡ºç‰ˆå¹´"],
  journal: ["åºè™Ÿ", "åˆŠå", "å‡ºç‰ˆè€…", "ä½œè€…", "æœŸæ•¸", "æœŸåˆŠåˆ†é¡", "è—æ›¸ä½ç½®"],
  book: ["åºè™Ÿ", "æ›¸å", "ä½œè€…", "å‡ºç‰ˆè€…", "å‡ºç‰ˆå¹´", "åˆ†é¡", "ISBN", "è—æ›¸ä½ç½®", "æ•¸é‡", "å·²å€Ÿå‡º", "æ­¸é‚„æ—¥æœŸ"]
};

function switchTab(tabName, btn) {
  document.querySelectorAll(".tab-buttons button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  if (tabName === "borrow") loadBorrowedList();
}

function loadCSV(file, type) {
  Papa.parse(file, {
    download: true,
    header: true,
    complete: function(results) {
      const cleanData = results.data.filter(row => Object.values(row).some(val => val && val.trim() !== ''));
      dataStore[type] = cleanData;
      renderTable(type, cleanData);
    }
  });
}

function renderTable(type, data) {
  const body = document.getElementById(`${type}-body`);
  body.innerHTML = '';
  data.forEach(row => {
    const tr = document.createElement('tr');
    columnsMap[type].forEach(col => {
      const td = document.createElement('td');
      if (type === 'book' && (col === 'å·²å€Ÿå‡º' || col === 'æ­¸é‚„æ—¥æœŸ')) {
        const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
        const sameBookRecords = records.filter(r => r.ISBN === row["ISBN"]);
        if (col === 'å·²å€Ÿå‡º') td.textContent = sameBookRecords.length;
        if (col === 'æ­¸é‚„æ—¥æœŸ') {
          const latest = sameBookRecords.at(-1);
          td.textContent = latest ? latest.returnDate : '';
        }
      } else {
        td.textContent = row[col] || '';
      }
      tr.appendChild(td);
    });
    if (type === 'book') {
      const td = document.createElement('td');
      const total = parseInt(row["æ•¸é‡"] || 0);
      const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
      const borrowed = records.filter(r => r.ISBN === row["ISBN"]).length;
      if (borrowed < total) {
        td.innerHTML = `<button onclick='openBorrowModal(${JSON.stringify(row)})'>ğŸ“– å€Ÿæ›¸</button>`;
      } else {
        td.textContent = 'âŒ ç„¡å¯å€Ÿ';
      }
      tr.appendChild(td);
    }
    body.appendChild(tr);
  });
}

function filterData(type) {
  const filters = Array.from(document.querySelectorAll(`#${type} .filter`));
  const filtered = dataStore[type].filter(row =>
    filters.every(input => {
      const key = input.dataset.key;
      return (row[key] || '').toLowerCase().includes(input.value.toLowerCase());
    })
  );
  renderTable(type, filtered);
}

function openBorrowModal(bookData) {
  currentBorrowBook = bookData;
  const today = new Date();
  const returnDay = new Date(today);
  returnDay.setDate(today.getDate() + 14);
  document.getElementById("modal-book-title").textContent = bookData["æ›¸å"];
  document.getElementById("borrow-date").textContent = today.toISOString().split("T")[0];
  document.getElementById("return-date").textContent = returnDay.toISOString().split("T")[0];
  document.getElementById("class-input").value = '';
  document.getElementById("name-input").value = '';
  document.getElementById("borrow-modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("borrow-modal").style.display = "none";
}

function confirmBorrow() {
  const cls = document.getElementById("class-input").value.trim();
  const name = document.getElementById("name-input").value.trim();
  if (!cls || !name) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");

  const borrowDate = new Date();
  const returnDate = new Date(borrowDate);
  returnDate.setDate(borrowDate.getDate() + 14);

  const record = {
    class: cls,
    name: name,
    book: currentBorrowBook["æ›¸å"],
    ISBN: currentBorrowBook["ISBN"],
    borrowDate: borrowDate.toISOString().split("T")[0],
    returnDate: returnDate.toISOString().split("T")[0],
  };

  const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
  records.push(record);
  localStorage.setItem("borrowRecords", JSON.stringify(records));

  closeModal();
  renderTable("book", dataStore["book"]);
  alert("âœ… å€Ÿæ›¸æˆåŠŸï¼");
}

function loadBorrowedList() {
  const tbody = document.getElementById("borrow-body");
  tbody.innerHTML = "";
  const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
  records.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.class}</td>
      <td>${r.name}</td>
      <td>${r.book}</td>
      <td>${r.ISBN}</td>
      <td>${r.borrowDate}</td>
      <td>${r.returnDate}</td>
      <td><button onclick="returnBook(${idx})">â†©ï¸ æ­¸é‚„</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function returnBook(index) {
  const records = JSON.parse(localStorage.getItem("borrowRecords") || "[]");
  records.splice(index, 1);
  localStorage.setItem("borrowRecords", JSON.stringify(records));
  loadBorrowedList();
  renderTable("book", dataStore["book"]);
}

window.onload = function() {
  loadCSV('thesis.csv', 'thesis');
  loadCSV('journal.csv', 'journal');
  loadCSV('books.csv', 'book');
}
</script>
</body>
</html>
