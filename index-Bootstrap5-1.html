<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æµ·å·¡ç½²åœ–æ›¸æŸ¥è©¢ç³»çµ±</title>

  <!-- Bootstrap CSS & JS -->
  <link rel="stylesheet" href="/assets/bootstrap.min.css">
  <script defer src="/assets/bootstrap.bundle.min.js"></script>

  <!-- PapaParse (æœ¬æ©Ÿé›¢ç·šç‰ˆ)ï¼Œä¸¦æä¾› CDN fallback -->
  <script src="/assets/js/papaparse.min.js"></script>
  <script>
    if (!window.Papa) {
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
      document.head.appendChild(s);
    }
  </script>

  <!-- å®¢è£½åŒ– CSS -->
  <style>
    body { background-color: #f3f4f6; }
    .banner { background: linear-gradient(to right, #3f51b5, #2196f3); color: #fff; }
    .banner h1 { margin-bottom: 0; }
    .table { border-radius: .5rem; overflow: hidden; }
    tr:hover td { background-color: #e8f5e9; }
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body class="bg-light">

  <!-- Banner -->
  <header class="banner py-3 d-flex align-items-center px-4">
    <img src="logo.png" alt="logo" class="me-3" style="height:80px" />
    <div>
      <h1 class="h5">æµ·å·¡ç½²æ•™è‚²è¨“ç·´æ¸¬è€ƒä¸­å¿ƒåœ–æ›¸æŸ¥è©¢ç³»çµ±</h1>
      <p class="mb-0 small">Coast Guard Administration Education and Training Testing Center Library Query System</p>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="mt-4">
    <ul class="nav nav-pills justify-content-center mb-3">
      <li class="nav-item"><button class="nav-link active" onclick="switchTab('thesis', this)">è«–æ–‡æŸ¥è©¢</button></li>
      <li class="nav-item"><button class="nav-link" onclick="switchTab('journal', this)">æœŸåˆŠæŸ¥è©¢</button></li>
      <li class="nav-item"><button class="nav-link" onclick="switchTab('book', this)">æ›¸ç±æŸ¥è©¢</button></li>
      <li class="nav-item"><button class="nav-link" onclick="switchTab('borrow', this)">å€Ÿå‡ºæŸ¥è©¢</button></li>
    </ul>
  </nav>

  <div class="container-fluid px-4">
    <!-- è«–æ–‡ æŸ¥è©¢ -->
    <section id="thesis" class="tab-content">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">
          <label class="mb-0">ğŸ“šè«–æ–‡æ¨™é¡Œï¼š</label>
          <input class="form-control filter" style="width:200px;" data-key="è«–æ–‡åç¨±">
          <label class="mb-0">ğŸ§‘â€ğŸ“ç ”ç©¶ç”Ÿï¼š</label>
          <input class="form-control filter" style="width:150px;" data-key="ç ”ç©¶ç”Ÿ">
          <label class="mb-0">ğŸ‘¨â€ğŸ«æŒ‡å°æ•™æˆï¼š</label>
          <input class="form-control filter" style="width:150px;" data-key="æŒ‡å°æ•™æˆ">
          <button class="btn btn-primary" onclick="filterData('thesis')">æœå°‹</button>
        </div>
      </div>
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-striped table-hover text-center text-nowrap">
          <thead class="table-primary">
            <tr>
              <th>åºè™Ÿ</th><th>è«–æ–‡åç¨±</th><th>ç ”ç©¶ç”Ÿ</th><th>æŒ‡å°æ•™æˆ</th><th>æ ¡é™¢åç¨±</th>
              <th>ç³»æ‰€åç¨±</th><th>å­¸ä½é¡åˆ¥</th><th>ç•¢æ¥­å­¸å¹´åº¦</th><th>è«–æ–‡å‡ºç‰ˆå¹´</th>
            </tr>
          </thead>
          <tbody id="thesis-body"></tbody>
        </table>
      </div>
    </section>

    <!-- æœŸåˆŠ æŸ¥è©¢ -->
    <section id="journal" class="tab-content d-none">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">
          <label class="mb-0">ğŸ“‘åˆŠåï¼š</label>
          <input class="form-control filter" style="width:200px;" data-key="åˆŠå">
          <label class="mb-0">æœŸæ•¸ï¼š</label>
          <input class="form-control filter" style="width:100px;" data-key="æœŸæ•¸">
          <label class="mb-0">å‡ºç‰ˆè€…ï¼š</label>
          <input class="form-control filter" style="width:200px;" data-key="å‡ºç‰ˆè€…">
          <button class="btn btn-primary" onclick="filterData('journal')">æœå°‹</button>
        </div>
      </div>
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-striped table-hover text-center text-nowrap">
          <thead class="table-info">
            <tr>
              <th>åºè™Ÿ</th><th>åˆŠå</th><th>å‡ºç‰ˆè€…</th><th>ä½œè€…</th><th>æœŸæ•¸</th>
              <th>æœŸåˆŠåˆ†é¡</th><th>è—æ›¸ä½ç½®</th>
            </tr>
          </thead>
          <tbody id="journal-body"></tbody>
        </table>
      </div>
    </section>

    <!-- æ›¸ç± æŸ¥è©¢ -->
    <section id="book" class="tab-content d-none">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap align-items-center gap-2">
          <label class="mb-0">ğŸ“–æ›¸åï¼š</label>
          <input class="form-control filter" style="width:200px;" data-key="æ›¸å">
          <label class="mb-0">ä½œè€…ï¼š</label>
          <input class="form-control filter" style="width:150px;" data-key="ä½œè€…">
          <label class="mb-0">åˆ†é¡ï¼š</label>
          <input class="form-control filter" style="width:150px;" data-key="åˆ†é¡">
          <button class="btn btn-primary" onclick="filterData('book')">æœå°‹</button>
        </div>
      </div>
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-striped table-hover text-center text-nowrap">
          <colgroup>
            <col style="width:4%"><!-- åºè™Ÿ -->
            <col style="width:18%"><!-- æ›¸å -->
            <col style="width:10%"><!-- ä½œè€… -->
            <col style="width:10%"><!-- å‡ºç‰ˆè€… -->
            <col style="width:6%"><!-- å‡ºç‰ˆå¹´ -->
            <col style="width:9%"><!-- åˆ†é¡ -->
            <col style="width:9%"><!-- ISBN -->
            <col style="width:8%"><!-- è—æ›¸ä½ç½® -->
            <col style="width:5%"><!-- æ•¸é‡ -->
            <col style="width:5%"><!-- å·²å€Ÿå‡º -->
            <col style="width:8%"><!-- æ­¸é‚„æ—¥æœŸ -->
            <col style="width:8%"><!-- æ“ä½œ -->
          </colgroup>
          <thead class="table-success">
            <tr>
              <th>åºè™Ÿ</th><th>æ›¸å</th><th>ä½œè€…</th><th>å‡ºç‰ˆè€…</th><th>å‡ºç‰ˆå¹´</th>
              <th>åˆ†é¡</th><th>ISBN</th><th>è—æ›¸ä½ç½®</th><th>æ•¸é‡</th>
              <th>å·²å€Ÿå‡º</th><th>æ­¸é‚„æ—¥æœŸ</th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="book-body"></tbody>
        </table>
      </div>
    </section>

    <!-- å€Ÿå‡º æŸ¥è©¢ -->
    <section id="borrow" class="tab-content d-none">
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-striped table-hover text-center text-nowrap">
          <thead class="table-warning">
            <tr>
              <th>ç­ç´š</th><th>å§“å</th><th>æ›¸å</th><th>ISBN</th><th>å€Ÿå‡ºæ—¥</th>
              <th>æ‡‰é‚„æ—¥</th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="borrow-body"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Borrow Modal -->
  <div class="modal fade" id="borrow-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ“– å€Ÿæ›¸ç™»è¨˜</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="modal-book-title" class="fw-semibold"></p>
          <div class="mb-3"><label class="form-label">ç­ç´š</label><input id="class-input" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å§“å</label><input id="name-input" class="form-control"></div>
          <p>å€Ÿå‡ºæ—¥ï¼š<span id="borrow-date"></span></p>
          <p>æ‡‰é‚„æ—¥ï¼š<span id="return-date"></span></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="confirmBorrow()">ç¢ºèªå€Ÿå‡º</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const dataStore={ thesis:[], journal:[], book:[] };
    let currentBorrowBook;
    const columns={ thesis:["åºè™Ÿ","è«–æ–‡åç¨±","ç ”ç©¶ç”Ÿ","æŒ‡å°æ•™æˆ","æ ¡é™¢åç¨±","ç³»æ‰€åç¨±","å­¸ä½é¡åˆ¥","ç•¢æ¥­å­¸å¹´åº¦","è«–æ–‡å‡ºç‰ˆå¹´"], journal:["åºè™Ÿ","åˆŠå","å‡ºç‰ˆè€…","ä½œè€…","æœŸæ•¸","æœŸåˆŠåˆ†é¡","è—æ›¸ä½ç½®"], book:["åºè™Ÿ","æ›¸å","ä½œè€…","å‡ºç‰ˆè€…","å‡ºç‰ˆå¹´","åˆ†é¡","ISBN","è—æ›¸ä½ç½®","æ•¸é‡","å·²å€Ÿå‡º","æ­¸é‚„æ—¥æœŸ"] };

    function switchTab(id,btn){
      document.querySelectorAll('.nav-link').forEach(el=>el.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(sec=>sec.classList.add('d-none'));
      if(id!=='borrow' && !dataStore[id].length) loadCSV(id+'.csv',id);
      if(id==='borrow') loadBorrowedList();
      document.getElementById(id).classList.remove('d-none');
    }

    function loadCSV(file,type){
      Papa.parse(file,{ download:true, header:true, skipEmptyLines:true, bom:true,
        complete(res){ dataStore[type]=res.data; render(type);} });
    }

    function render(type){
      const body=document.getElementById(type+'-body'); body.innerHTML='';
      dataStore[type].forEach(r=>{
        const tr=document.createElement('tr');
        columns[type].forEach(col=>{
          const td=document.createElement('td');
          if(type==='book'&&(col==='å·²å€Ÿå‡º'||col==='æ­¸é‚„æ—¥æœŸ')){
            const recs=JSON.parse(localStorage.getItem('borrowRecords')||'[]').filter(x=>x.ISBN===r.ISBN);
            td.textContent=col==='å·²å€Ÿå‡º'?recs.length:(recs.at(-1)?.returnDate||'');
          }else td.textContent=r[col]||'';
          tr.appendChild(td);
        });
        if(type==='book'){
          const td=document.createElement('td'), total=+r.æ•¸é‡, borrowed=JSON.parse(localStorage.getItem('borrowRecords')||'[]').filter(x=>x.ISBN===r.ISBN).length;
          td.innerHTML=borrowed<total?`<button class="btn btn-sm btn-success" onclick='openBorrowModal(${JSON.stringify(r)})'>å€Ÿ</button>`:'ç„¡';
          tr.appendChild(td);
        }
        body.appendChild(tr);
      });
    }

    function filterData(type){
      const inputs=[...document.querySelectorAll(`#${type} .filter`)];
      const filtered=dataStore[type].filter(r=>inputs.every(i=>r[i.dataset.key]?.toString().toLowerCase().includes(i.value.trim().toLowerCase())));
      const body=document.getElementById(type+'-body'); body.innerHTML='';
      filtered.forEach(r=>{
        const tr=document.createElement('tr');
        columns[type].forEach(col=>{
          const td=document.createElement('td');
          if(type==='book'&&(col==='å·²å€Ÿå‡º'||col==='æ­¸é‚„æ—¥æœŸ')){
            const recs=JSON.parse(localStorage.getItem('borrowRecords')||'[]').filter(x=>x.ISBN===r.ISBN);
            td.textContent=col==='å·²å€Ÿå‡º'?recs.length:(recs.at(-1)?.returnDate||'');
          }else td.textContent=r[col]||'';
          tr.appendChild(td);
        });
        if(type==='book'){
          const td=document.createElement('td'), total=+r.æ•¸ëŸ‰, borrowed=JSON.parse(localStorage.getItem('borrowRecords')||'[]').filter(x=>x.ISBN===r.ISBN).length;
          td.innerHTML=borrowed<total?`<button class="btn btn-sm btn-success" onclick='openBorrowModal(${JSON.stringify(r)})'>å€Ÿ</button>`:'ç„¡';
          tr.appendChild(td);
        }
        body.appendChild(tr);
      });
    }

    function openBorrowModal(data){
      currentBorrowBook=data;
      const today=new Date(), ret=new Date(today); ret.setDate(today.getDate()+14);
      document.getElementById('modal-book-title').textContent=data.æ›¸å;
      document.getElementById('borrow-date').textContent=today.toISOString().slice(0,10);
      document.getElementById('return-date').textContent=ret.toISOString().slice(0,10);
      const modalEl=document.getElementById('borrow-modal');
      const modal=bootstrap.Modal.getOrCreateInstance(modalEl,{backdrop:'static'});
      modal.show();
    }

    function confirmBorrow(){
      const cls=document.getElementById('class-input').value, name=document.getElementById('name-input').value;
      if(!cls||!name) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
      const recs=JSON.parse(localStorage.getItem('borrowRecords')||'[]');
      recs.push({ class:cls,name,book:currentBorrowBook.æ›¸å,ISBN:currentBorrowBook.ISBN,borrowDate:document.getElementById('borrow-date').textContent,returnDate:document.getElementById('return-date').textContent });
      localStorage.setItem('borrowRecords',JSON.stringify(recs));
      render('book'); bootstrap.Modal.getInstance(document.getElementById('borrow-modal')).hide(); alert('âœ… å€Ÿæ›¸æˆåŠŸ');
    }

    function loadBorrowedList(){
      const body=document.getElementById('borrow-body'); body.innerHTML='';
      JSON.parse(localStorage.getItem('borrowRecords')||'[]').forEach((r,i)=>{ const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.class}</td><td>${r.name}</td><td>${r.book}</td><td>${r.ISBN}</td><td>${r.borrowDate}</td><td>${r.returnDate}</td><td><button class="btn btn-sm btn-danger" onclick="returnBook(${i})">é‚„</button></td>`;
        body.appendChild(tr);
      });
    }

    function returnBook(i){
      const recs=JSON.parse(localStorage.getItem('borrowRecords')||'[]'); recs.splice(i,1);
      localStorage.setItem('borrowRecords',JSON.stringify(recs)); render('book'); loadBorrowedList();
    }

    window.onload=()=>{
      loadCSV('thesis.csv','thesis');
      loadCSV('journal.csv','journal');
      loadCSV('books.csv','book');
    };
  </script>
</body>
</html>
